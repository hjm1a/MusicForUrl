services:
  music-for-url:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:20-alpine}
        ALPINE_REPO_MIRROR: ${ALPINE_REPO_MIRROR:-}
        NPM_REGISTRY: ${NPM_REGISTRY:-}
    container_name: music-for-url-1c1g
    ports:
      - "3000:3000"
    volumes:
      - music-for-url-data:/app/data
      # - ../data:/app/data
    environment:
      NODE_ENV: production
      PORT: 3000
      # 1G 内存建议限制 Node 堆，避免和 ffmpeg 抢内存
      NODE_OPTIONS: --max-old-space-size=256
      ENCRYPTION_KEY: "your-32-character-secret-key-here"

      # 更保守的限流，避免把队列/CPU 打爆
      RATE_LIMIT_GLOBAL: 80
      RATE_LIMIT_PARSE: 10
      RATE_LIMIT_HLS_STREAM: 20
      RATE_LIMIT_AUTH: 10

      # HLS/FFmpeg：极限省 CPU
      HLS_MAX_CONCURRENT_JOBS: 1
      HLS_MAX_QUEUE: 3
      HLS_AUTO_PRELOAD_COUNT: 0
      HLS_FFMPEG_THREADS: 1
      COVER_WIDTH: 854
      COVER_HEIGHT: 480
      COVER_FPS: 1
      MUSIC_QUALITY: low

      # 缓存控制：小盘/小机建议更小
      HLS_CACHE_MAX_SIZE_GB: 1
      HLS_CACHE_MAX_AGE_HOURS: 12

    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1g

volumes:
  music-for-url-data:

