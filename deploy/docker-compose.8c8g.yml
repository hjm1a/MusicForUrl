services:
  music-for-url:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:20-alpine}
        ALPINE_REPO_MIRROR: ${ALPINE_REPO_MIRROR:-}
        NPM_REGISTRY: ${NPM_REGISTRY:-}
    container_name: music-for-url-8c8g
    ports:
      - "3000:3000"
    volumes:
      - music-for-url-data:/app/data
      # - ../data:/app/data
    environment:
      NODE_ENV: production
      PORT: 3000
      NODE_OPTIONS: --max-old-space-size=2048
      ENCRYPTION_KEY: "your-32-character-secret-key-here"
      CACHE_TTL: 86400

      # HLS/FFmpeg：高并发（按实际 CPU 负载再调）
      HLS_MAX_CONCURRENT_JOBS: 4
      HLS_MAX_QUEUE: 20
      HLS_AUTO_PRELOAD_COUNT: 2
      HLS_FFMPEG_THREADS: 2
      COVER_WIDTH: 1920
      COVER_HEIGHT: 1080
      COVER_FPS: 10
      MUSIC_QUALITY: low

      # 缓存容量更大
      HLS_CACHE_MAX_SIZE_GB: 20

      # 更宽松限流（可选）
      RATE_LIMIT_GLOBAL: 300
      RATE_LIMIT_PARSE: 60
      RATE_LIMIT_HLS_STREAM: 120
      RATE_LIMIT_AUTH: 15

    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '8.0'
          memory: 8g

volumes:
  music-for-url-data:

