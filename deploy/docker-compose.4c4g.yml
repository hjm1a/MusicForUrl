services:
  music-for-url:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        NODE_IMAGE: ${NODE_IMAGE:-node:20-alpine}
        ALPINE_REPO_MIRROR: ${ALPINE_REPO_MIRROR:-}
        NPM_REGISTRY: ${NPM_REGISTRY:-}
    container_name: music-for-url-4c4g
    ports:
      - "3000:3000"
    volumes:
      - music-for-url-data:/app/data
      # - ../data:/app/data
    environment:
      NODE_ENV: production
      PORT: 3000
      NODE_OPTIONS: --max-old-space-size=1024
      ENCRYPTION_KEY: "your-32-character-secret-key-here"
      CACHE_TTL: 86400

      # HLS/FFmpeg：中等并发
      HLS_MAX_CONCURRENT_JOBS: 2
      HLS_MAX_QUEUE: 10
      HLS_AUTO_PRELOAD_COUNT: 1
      HLS_FFMPEG_THREADS: 2
      COVER_WIDTH: 1280
      COVER_HEIGHT: 720
      COVER_FPS: 5
      MUSIC_QUALITY: low

      # 缓存容量可适当增加
      HLS_CACHE_MAX_SIZE_GB: 8

    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 4g

volumes:
  music-for-url-data:

