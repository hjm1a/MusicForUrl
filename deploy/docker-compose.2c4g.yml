services:
  music-for-url:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
      args:
        # 可选：基础镜像（用于无法访问 Docker Hub 时切换到可用镜像源）
        # 示例（按你网络可用的镜像改）：
        # NODE_IMAGE: registry.cn-hangzhou.aliyuncs.com/library/node:20-alpine
        NODE_IMAGE: ${NODE_IMAGE:-node:20-alpine}
        # 可选：Alpine 仓库镜像（不带协议），例如 mirrors.aliyun.com/alpine
        ALPINE_REPO_MIRROR: ${ALPINE_REPO_MIRROR:-}
        # 可选：npm 镜像，例如 https://registry.npmmirror.com
        NPM_REGISTRY: ${NPM_REGISTRY:-}
    container_name: music-for-url-2c4g
    ports:
      - "3000:3000"
    volumes:
      # 数据持久化（SQLite + HLS 分片缓存）
      # 推荐：named volume（Windows/WSL 的 bind mount 下 SQLite 可能出现 disk I/O error）
      - music-for-url-data:/app/data
      # 如需绑定到宿主机目录（Linux 服务器更常用），改为：
      # - ../data:/app/data
    environment:
      # 基础
      NODE_ENV: production
      PORT: 3000
      # 限制 Node 内存（4G 机器更稳，避免极端情况下占用过大）
      NODE_OPTIONS: --max-old-space-size=512

      # 必填：Cookie 加密密钥（至少16位，建议32位）
      # 部署前务必修改！
      # 注意：如果你用纯数字密钥，请务必加引号，否则 YAML 可能按数字解析导致长度/内容变化
      ENCRYPTION_KEY: "your-32-character-secret-key-here"

      # 歌单缓存（秒）
      CACHE_TTL: 86400

      # ===================
      # 2核4G 推荐：降压配置
      # ===================
      # FFmpeg 并发：2核机器建议 1（更稳）
      HLS_MAX_CONCURRENT_JOBS: 1
      # 等待队列：过大只会堆积请求、拖垮响应
      HLS_MAX_QUEUE: 6
      # 预加载：0 最省资源；想更顺滑可改为 1
      HLS_AUTO_PRELOAD_COUNT: 0

      # 限制单个 FFmpeg 进程线程数（避免把 CPU 打满）
      HLS_FFMPEG_THREADS: 1

      # 静态封面视频：降低分辨率 + 帧率，可显著减轻 x264 压力
      COVER_WIDTH: 1280
      COVER_HEIGHT: 720
      COVER_FPS: 2

      # 音质：low 文件小、下载快（更省带宽与磁盘）
      MUSIC_QUALITY: low

      # 可选：更保守的限流（防止瞬时请求把转码队列打爆）
      RATE_LIMIT_GLOBAL: 150
      RATE_LIMIT_PARSE: 20
      RATE_LIMIT_HLS_STREAM: 40
      RATE_LIMIT_AUTH: 10

      # 反代环境可选
      # BASE_URL: https://music.example.com
      # TRUST_PROXY: 1

    restart: unless-stopped

    # 资源限制（需要 docker compose 加 --compatibility 才会在非 swarm 模式生效）
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4g

volumes:
  music-for-url-data:

